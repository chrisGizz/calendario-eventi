<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendario Eventi</title>

  <!-- FullCalendar (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#fafafa; }
    header { padding: 16px 20px; background: white; border-bottom: 1px solid #eaeaea; }
    header h1 { margin: 0; font-size: 18px; }
    #wrap { max-width: 1100px; margin: 18px auto; padding: 0 14px; }
    #calendar { background: white; border:1px solid #eaeaea; border-radius: 12px; padding: 10px; }
    .modal-backdrop {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,.45);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  z-index: 2147483647 !important;

  /* importantissimo: intercetta i click */
  pointer-events: auto;
}


.modal {
  background: #fff !important;
  width: min(720px, 100%);
  border-radius: 14px;
  padding: 16px 16px 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,.25);
  max-height: 80vh;
  overflow: auto;
}


    .modal h2 { margin: 0 0 6px; font-size: 18px; }
    .meta { color:#444; font-size: 14px; margin: 0 0 12px; }
    .desc { white-space: pre-wrap; color:#222; margin: 0 0 12px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .btn { border:1px solid #ddd; background:#fff; padding:8px 10px; border-radius: 10px; cursor:pointer; text-decoration:none; color:#111; font-size:14px; }
    .btn.primary { background:#111; color:#fff; border-color:#111; }
    .small { font-size: 12px; color:#666; margin-top: 10px; }
    /* layer super-top per la modal */
.modal-backdrop { z-index: 2147483647 !important; }

/* blocca qualsiasi click/hover sul calendario quando la modal è aperta */
body.modal-open #calendar {
  pointer-events: none;
  user-select: none;
  filter: blur(0px);
}

/* evita che il calendario “buca” la modal per stacking context strani */
body.modal-open .fc {
  position: relative;
  z-index: 1;
}

/* la modal sta ancora più su */
body.modal-open .modal {
  position: relative;
  z-index: 2147483647 !important;
  background: #fff;
}

  </style>
</head>
<body>
  <header>
    <h1>Calendario eventi</h1>
  </header>

  <div id="wrap">
    <div id="calendar"></div>
    <p id="status" class="small"></p>
    <p class="small">
      *Gli eventi sono gestiti da un foglio Google (aggiornamento automatico).*
    </p>
  </div>

  <!-- Modal -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h2 id="mTitle"></h2>
      <p class="meta" id="mMeta"></p>
      <p class="desc" id="mDesc"></p>
      <div id="gate" style="margin:12px 0; padding:12px; border:1px solid #eee; border-radius:12px;">
  <div style="display:flex; gap:10px; flex-wrap:wrap;">
    <div style="flex:1; min-width:200px;">
      <label style="display:block; font-size:12px; color:#555; margin-bottom:4px;">Nome</label>
      <input id="gateName" type="text" autocomplete="given-name"
             style="width:100%; padding:10px; border:1px solid #ddd; border-radius:10px;">
    </div>
    <div style="flex:1; min-width:200px;">
      <label style="display:block; font-size:12px; color:#555; margin-bottom:4px;">Cognome</label>
      <input id="gateSurname" type="text" autocomplete="family-name"
             style="width:100%; padding:10px; border:1px solid #ddd; border-radius:10px;">
    </div>
  </div>

  <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;">
    <button id="gateContinue" class="btn primary" type="button">Continua</button>
  </div>

  <p id="gateError" class="small" style="color:#b00020; display:none; margin-top:8px;">
    Inserisci nome e cognome per visualizzare il link.
  </p>
</div>

     <div class="actions" id="actions">
  <a id="mTeams" class="btn primary" href="#" target="_blank" rel="noreferrer" style="display:none;">
    Apri link Teams
  </a>
 <a id="mOutlook" class="btn primary" href="#" style="display:none;">
  Aggiungi a Outlook
</a>
       <button id="mClose" class="btn" type="button">Chiudi</button>
</div>

      <p class="small" id="mHint"></p>
    </div>
  </div>

<script>
  const SIGNUP_ENDPOINT = "https://script.google.com/macros/s/AKfycbwqsXYiMCFC6sqfmKJfdyDhANs0NIArsutK7dqpNzxiMQHX_8K0vkudrcqkY_rvbxaF/exec";

  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLMB1CPo-71JPfgohwLeO8arfYsDROVEJo9aAu31VDQhFbZXDJDZywwg4jwhKJ1jsw-3lq0OOfiGPx/pub?gid=0&single=true&output=csv";

  function parseCSV(text) {
    // parser semplice CSV (va bene se non metti virgole “strane” nei campi)
    const lines = text.trim().split(/\r?\n/);
    const headers = lines.shift().split(",").map(h => h.trim());
    return lines.map(line => {
      const cols = line.split(","); // semplice
      const obj = {};
      headers.forEach((h, i) => obj[h] = (cols[i] ?? "").trim());
      return obj;
    });
  }

  function formatDateRange(startStr, endStr) {
    const start = new Date(startStr);
    const end = new Date(endStr);
    const opts = { weekday:'short', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' };
    const s = start.toLocaleString('it-IT', opts);
    const e = end.toLocaleString('it-IT', opts);
    return `${s} → ${e}`;
  }

  function mailtoForEvent(ev) {
    const subject = encodeURIComponent(`[Invito] ${ev.title}`);
    const body = encodeURIComponent(
`Ciao,
sei invitato/a a: ${ev.title}

Quando: ${formatDateRange(ev.start, ev.end)}
Link Teams: ${ev.extendedProps.teamsLink || "(non disponibile)"}

Dettagli:
${ev.extendedProps.description || ""}

A presto`);
    return `mailto:?subject=${subject}&body=${body}`;
  }
function setGatedVisibility(isUnlocked) {
  const teams = document.getElementById("mTeams");
  const gate = document.getElementById("gate");

  if (isUnlocked) {
    gate.style.display = "none";
    teams.style.display = teams.href && teams.href !== "#" ? "inline-block" : "none";
    return;
  }

  gate.style.display = "block";
  teams.style.display = "none";
}

function pad2(n){ return String(n).padStart(2,"0"); }

function toICSDate(d) {
  // UTC in formato YYYYMMDDTHHMMSSZ
  const dt = new Date(d);
  return dt.getUTCFullYear()
    + pad2(dt.getUTCMonth()+1)
    + pad2(dt.getUTCDate())
    + "T"
    + pad2(dt.getUTCHours())
    + pad2(dt.getUTCMinutes())
    + pad2(dt.getUTCSeconds())
    + "Z";
}

function escapeICSText(s) {
  return String(s || "")
    .replace(/\\/g, "\\\\")
    .replace(/\n/g, "\\n")
    .replace(/,/g, "\\,")
    .replace(/;/g, "\\;");
}

function buildICS(ev) {
  const dtStart = toICSDate(ev.start);
  const dtEnd = toICSDate(ev.end || ev.start); // se manca end, usa start
  const uid = escapeICSText(ev.id || crypto.randomUUID());

  const title = escapeICSText(ev.title);
  const desc = escapeICSText(
    (ev.extendedProps?.description || "") +
    "\n\nLink Teams:\n" + (ev.extendedProps?.teamsLink || "")
  );

  const url = escapeICSText(ev.extendedProps?.teamsLink || "");

  return [
    "BEGIN:VCALENDAR",
    "VERSION:2.0",
    "PRODID:-//Calendario Eventi//IT",
    "CALSCALE:GREGORIAN",
    "METHOD:PUBLISH",
    "BEGIN:VEVENT",
    `UID:${uid}`,
    `DTSTAMP:${toICSDate(new Date())}`,
    `DTSTART:${dtStart}`,
    `DTEND:${dtEnd}`,
    `SUMMARY:${title}`,
    `DESCRIPTION:${desc}`,
    url ? `URL:${url}` : "",
    "END:VEVENT",
    "END:VCALENDAR"
  ].filter(Boolean).join("\r\n");
}

function downloadICS(ev) {
  const ics = buildICS(ev);
  const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `${(ev.title || "evento").replace(/[^\w\d-_]+/g, "_")}.ics`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  // libera la memoria
  setTimeout(() => URL.revokeObjectURL(url), 1500);
}

  function openModal(eventObj) {
    document.body.classList.add("modal-open");
    const ev = eventObj;
    document.getElementById("mTitle").textContent = ev.title;
    document.getElementById("mMeta").textContent = formatDateRange(ev.start, ev.end);
    document.getElementById("mDesc").textContent = ev.extendedProps.description || "";

    const teams = document.getElementById("mTeams");
    const teamsLink = ev.extendedProps.teamsLink || "#";
    teams.href = teamsLink;
  // prepara bottone outlook (nascosto finché non si sblocca)
const outlookBtn = document.getElementById("mOutlook");
outlookBtn.style.display = "none";
outlookBtn.onclick = () => downloadICS(ev);

    

    document.getElementById("mHint").textContent =
      "Nota: l’invio email avviene dal tuo programma/webmail aziendale. Per tracciare a chi lo hai inviato serve un registro (manuale o script).";

    const backdrop = document.getElementById("backdrop");
   setGatedVisibility(false);
    backdrop.style.display = "flex";
    // focus sul nome per comodità
setTimeout(() => document.getElementById("gateName").focus(), 50);

    // reset gate UI
document.getElementById("gateName").value = "";
document.getElementById("gateSurname").value = "";
document.getElementById("gateError").style.display = "none";

// salvo evento corrente per usarlo nel click del bottone
window.__currentEvent = ev;

// parte bloccato
setGatedVisibility(false);

  }

  function closeModal() {
   document.body.classList.remove("modal-open");
   document.getElementById("backdrop").style.display = "none";
  }

  document.getElementById("mClose").addEventListener("click", closeModal);
  document.getElementById("backdrop").addEventListener("click", (e) => {
    if (e.target.id === "backdrop") closeModal();
  });
document.getElementById("gateContinue").addEventListener("click", () => {
  const name = document.getElementById("gateName").value.trim();
  const surname = document.getElementById("gateSurname").value.trim();

  if (!name || !surname) {
    document.getElementById("gateError").style.display = "block";
    return;
  }

  document.getElementById("gateError").style.display = "none";

  // (opzionale) ricorda il nome sul browser
  try {
    localStorage.setItem("calendar_attendee_name", name);
    localStorage.setItem("calendar_attendee_surname", surname);
  } catch {}

  // sblocca i pulsanti (Teams + Invita)
 const payload = {
  nome: name,
  cognome: surname,
  evento: window.__currentEvent.title,
  eventId: window.__currentEvent.id
};

// Invia senza leggere risposta (evita problemi CORS)
const ok = navigator.sendBeacon(
  SIGNUP_ENDPOINT,
  new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" })
);

if (ok) {
  setGatedVisibility(true); // sblocca link
  document.getElementById("mOutlook").style.display = "inline-block";

} else {
  alert("Errore nel salvataggio. Riprova.");
}

});

  async function loadEvents() {
    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("Impossibile caricare il CSV pubblicato.");
    const text = await res.text();
    const rows = parseCSV(text);

    return rows
      .filter(r => r.title && r.start)
      .map(r => ({
        id: r.id || crypto.randomUUID(),
        title: r.title,
        start: r.start,
        end: r.end || null,
        extendedProps: {
          teamsLink: r.teamsLink || "",
          description: r.description || ""
        }
      }));
  }

  document.addEventListener("DOMContentLoaded", async function() {
    const calendarEl = document.getElementById("calendar");
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      locale: "it",
      height: "auto",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
      },
      eventClick: function(info) {
        info.jsEvent.preventDefault();
        openModal(info.event);
      }
    });

    calendar.render();

    try {
      const events = await loadEvents();
      calendar.addEventSource(events);
    } catch (err) {
  document.getElementById("status").textContent =
    "Errore caricamento eventi: " + err.message;

  console.error(err);
}
  });
</script>
</body>
</html>
