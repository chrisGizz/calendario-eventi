<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendario Eventi</title>

  <!-- FullCalendar (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#fafafa; }
    header { padding: 16px 20px; background: white; border-bottom: 1px solid #eaeaea; }
    header h1 { margin: 0; font-size: 18px; }
    #wrap { max-width: 1100px; margin: 18px auto; padding: 0 14px; }
    #calendar { background: white; border:1px solid #eaeaea; border-radius: 12px; padding: 10px; }
    .modal-backdrop {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,.45);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  z-index: 2147483647 !important;

  /* importantissimo: intercetta i click */
  pointer-events: auto;
}


.modal {
  background: #fff !important;
  width: min(720px, 100%);
  border-radius: 14px;
  padding: 16px 16px 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,.25);
  max-height: 80vh;
  overflow: auto;
}


    .modal h2 { margin: 0 0 6px; font-size: 18px; }
    .meta { color:#444; font-size: 14px; margin: 0 0 12px; }
    .desc { white-space: pre-wrap; color:#222; margin: 0 0 12px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .btn { border:1px solid #ddd; background:#fff; padding:8px 10px; border-radius: 10px; cursor:pointer; text-decoration:none; color:#111; font-size:14px; }
    .btn.primary { background:#111; color:#fff; border-color:#111; }
    .small { font-size: 12px; color:#666; margin-top: 10px; }
    /* layer super-top per la modal */
.modal-backdrop { z-index: 2147483647 !important; }

/* blocca qualsiasi click/hover sul calendario quando la modal è aperta */
body.modal-open #calendar {
  pointer-events: none;
  user-select: none;
  filter: blur(0px);
}

/* evita che il calendario “buca” la modal per stacking context strani */
body.modal-open .fc {
  position: relative;
  z-index: 1;
}

/* la modal sta ancora più su */
body.modal-open .modal {
  position: relative;
  z-index: 2147483647 !important;
  background: #fff;
}

  </style>
</head>
<body>
  <header>
    <h1>Calendario eventi</h1>
  </header>

  <div id="wrap">
    <div id="calendar"></div>
    <p class="small">
      *Gli eventi sono gestiti da un foglio Google (aggiornamento automatico).*
    </p>
  </div>

  <!-- Modal -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h2 id="mTitle"></h2>
      <p class="meta" id="mMeta"></p>
      <p class="desc" id="mDesc"></p>
      <div class="actions">
        <a id="mTeams" class="btn" href="#" target="_blank" rel="noreferrer">Apri link Teams</a>
        <a id="mInvite" class="btn primary" href="#">Invita via email</a>
        <button id="mClose" class="btn" type="button">Chiudi</button>
      </div>
      <p class="small" id="mHint"></p>
    </div>
  </div>

<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLMB1CPo-71JPfgohwLeO8arfYsDROVEJo9aAu31VDQhFbZXDJDZywwg4jwhKJ1jsw-3lq0OOfiGPx/pub?gid=0&single=true&output=csv";

  function parseCSV(text) {
    // parser semplice CSV (va bene se non metti virgole “strane” nei campi)
    const lines = text.trim().split(/\r?\n/);
    const headers = lines.shift().split(",").map(h => h.trim());
    return lines.map(line => {
      const cols = line.split(","); // semplice
      const obj = {};
      headers.forEach((h, i) => obj[h] = (cols[i] ?? "").trim());
      return obj;
    });
  }

  function formatDateRange(startStr, endStr) {
    const start = new Date(startStr);
    const end = new Date(endStr);
    const opts = { weekday:'short', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' };
    const s = start.toLocaleString('it-IT', opts);
    const e = end.toLocaleString('it-IT', opts);
    return `${s} → ${e}`;
  }

  function mailtoForEvent(ev) {
    const subject = encodeURIComponent(`[Invito] ${ev.title}`);
    const body = encodeURIComponent(
`Ciao,
sei invitato/a a: ${ev.title}

Quando: ${formatDateRange(ev.start, ev.end)}
Link Teams: ${ev.extendedProps.teamsLink || "(non disponibile)"}

Dettagli:
${ev.extendedProps.description || ""}

A presto`);
    return `mailto:?subject=${subject}&body=${body}`;
  }

  function openModal(eventObj) {
    document.body.classList.add("modal-open");
    const ev = eventObj;
    document.getElementById("mTitle").textContent = ev.title;
    document.getElementById("mMeta").textContent = formatDateRange(ev.start, ev.end);
    document.getElementById("mDesc").textContent = ev.extendedProps.description || "";

    const teams = document.getElementById("mTeams");
    const teamsLink = ev.extendedProps.teamsLink || "#";
    teams.href = teamsLink;
    teams.style.display = teamsLink && teamsLink !== "#" ? "inline-block" : "none";

    const invite = document.getElementById("mInvite");
    invite.href = mailtoForEvent(ev);

    document.getElementById("mHint").textContent =
      "Nota: l’invio email avviene dal tuo programma/webmail aziendale. Per tracciare a chi lo hai inviato serve un registro (manuale o script).";

    const backdrop = document.getElementById("backdrop");
    backdrop.style.display = "flex";
  }

  function closeModal() {
   document.body.classList.remove("modal-open");
   document.getElementById("backdrop").style.display = "none";
  }

  document.getElementById("mClose").addEventListener("click", closeModal);
  document.getElementById("backdrop").addEventListener("click", (e) => {
    if (e.target.id === "backdrop") closeModal();
  });

  async function loadEvents() {
    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("Impossibile caricare il CSV pubblicato.");
    const text = await res.text();
    const rows = parseCSV(text);

    return rows
      .filter(r => r.title && r.start)
      .map(r => ({
        id: r.id || crypto.randomUUID(),
        title: r.title,
        start: r.start,
        end: r.end || null,
        extendedProps: {
          teamsLink: r.teamsLink || "",
          description: r.description || ""
        }
      }));
  }

  document.addEventListener("DOMContentLoaded", async function() {
    const calendarEl = document.getElementById("calendar");
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      locale: "it",
      height: "auto",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
      },
      eventClick: function(info) {
        info.jsEvent.preventDefault();
        openModal(info.event);
      }
    });

    calendar.render();

    try {
      const events = await loadEvents();
      calendar.addEventSource(events);
    } catch (err) {
      calendarEl.insertAdjacentHTML("beforebegin",
        `<p style="color:#b00020;background:#fff;border:1px solid #ffd7db;padding:10px;border-radius:10px;">
          Errore: ${err.message}
        </p>`);
      console.error(err);
    }
  });
</script>
</body>
</html>
